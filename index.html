<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>AR Video Call Demo</title>
  <style>
    body { margin: 0; overflow: hidden; }
    video { display: none; } /* hide HTML video, only used as texture */
  </style>
</head>
<body>
  <video id="remoteVideo" autoplay playsinline></video>
  <video id="localVideo" autoplay playsinline muted></video>

  <script src="https://unpkg.com/three@0.160.0/build/three.min.js"></script>
  <script src="https://unpkg.com/three@0.160.0/examples/jsm/webxr/ARButton.js"></script>
  <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>

  <script>
    let camera, scene, renderer;
    let videoPlane;
    let remoteVideo = document.getElementById("remoteVideo");
    let localVideo = document.getElementById("localVideo");

    // ========== AR Scene Setup ==========
    scene = new THREE.Scene();
    camera = new THREE.PerspectiveCamera();

    renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.xr.enabled = true;
    document.body.appendChild(renderer.domElement);

    document.body.appendChild(ARButton.createButton(renderer, { requiredFeatures: ["hit-test"] }));

    // ========== Video Texture ==========
    const videoTexture = new THREE.VideoTexture(remoteVideo);
    const geometry = new THREE.PlaneGeometry(1, 0.75); // 4:3 aspect
    const material = new THREE.MeshBasicMaterial({ map: videoTexture, side: THREE.DoubleSide });
    videoPlane = new THREE.Mesh(geometry, material);
    videoPlane.position.set(0, 1.5, -2);
    scene.add(videoPlane);

    // ========== Drag Controls ==========
    const raycaster = new THREE.Raycaster();
    const tapPosition = new THREE.Vector2();
    let selectedObject = null;

    function getTapPosition(event) {
      const touch = event.touches[0];
      tapPosition.x = (touch.clientX / window.innerWidth) * 2 - 1;
      tapPosition.y = -(touch.clientY / window.innerHeight) * 2 + 1;
    }

    window.addEventListener("touchstart", (event) => {
      getTapPosition(event);
      raycaster.setFromCamera(tapPosition, camera);
      const intersects = raycaster.intersectObjects([videoPlane], true);
      if (intersects.length > 0) {
        selectedObject = intersects[0].object;
      }
    });

    window.addEventListener("touchmove", (event) => {
      if (!selectedObject) return;
      getTapPosition(event);
      raycaster.setFromCamera(tapPosition, camera);

      // Move along a floor plane (y = 1.5 for eye level)
      const plane = new THREE.Plane(new THREE.Vector3(0, 1, 0), -1.5);
      const newPos = new THREE.Vector3();
      raycaster.ray.intersectPlane(plane, newPos);

      if (newPos) {
        selectedObject.position.copy(newPos);
      }
    });

    window.addEventListener("touchend", () => {
      selectedObject = null;
    });

    // ========== WebRTC Setup ==========
    const peer = new Peer();

    peer.on("open", id => {
      console.log("My Peer ID:", id);
      alert("Your Peer ID: " + id);
    });

    navigator.mediaDevices.getUserMedia({ video: true, audio: true })
      .then(stream => {
        localVideo.srcObject = stream;

        peer.on("call", call => {
          call.answer(stream);
          call.on("stream", remoteStream => {
            remoteVideo.srcObject = remoteStream;
          });
        });

        // For quick testing: enter remote ID manually
        const remoteId = prompt("Enter remote peer ID to call (or leave blank to wait):");
        if (remoteId) {
          const call = peer.call(remoteId, stream);
          call.on("stream", remoteStream => {
            remoteVideo.srcObject = remoteStream;
          });
        }
      })
      .catch(err => console.error("getUserMedia error:", err));

    // ========== Animation Loop ==========
    renderer.setAnimationLoop(() => {
      renderer.render(scene, camera);
    });
  </script>
</body>
</html>
